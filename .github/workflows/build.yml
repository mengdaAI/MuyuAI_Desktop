name: Build & Release

on:
  push:
    tags:
      - 'v*'  # ä»»ä½• v å¼€å¤´çš„ tag éƒ½ä¼šè§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            buildArgs: "--mac dmg --x64"
            artifactName: mac-intel-dmg
            artifactPath: "dist/*.dmg"
          - os: macos-14
            buildArgs: "--mac dmg --arm64"
            artifactName: mac-apple-silicon-dmg
            artifactPath: "dist/*.dmg"
          - os: windows-latest
            buildArgs: "--win nsis"
            artifactName: windows-exe
            artifactPath: "dist/*.exe"
    runs-on: ${{ matrix.os }}

    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install root dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install --prefer-offline --no-audit
        continue-on-error: false

      - name: ðŸ” Import Apple signing certificate
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Allow codesign to access the certificate
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "âœ… Certificate imported successfully"

      - name: ðŸ§± Build Electron target
        env:
          MUYU_API_DOMAIN: https://muyu-api.mengdaai.com
          MUYU_WEB_URL: https://muyu-web.mengdaai.com
          STT_BACKEND_ENDPOINT: wss://muyu-api.mengdaai.com/api/v1/stt/stream
          # macOS signing and notarization (electron-builder built-in)
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          npm run build:renderer
          npx electron-builder ${{ matrix.buildArgs }} --publish never

      - name: ðŸ“‹ List dist directory
        shell: bash
        run: ls -lah dist/ || dir dist\

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifactName }}
          path: ${{ matrix.artifactPath }}
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ðŸ“‹ List artifacts
        run: |
          ls -lah artifacts/
          find artifacts -type f

      - name: ï¿½ Generate update metadata files
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # Remove v prefix
          
          # Find build artifacts
          MAC_ARM64_DMG=$(find artifacts -name "*-mac-arm64.dmg" -type f | head -1)
          MAC_X64_DMG=$(find artifacts -name "*-mac-x64.dmg" -type f | head -1)
          WIN_EXE=$(find artifacts -name "*-win-x64.exe" -type f | head -1)
          
          echo "Found artifacts:"
          echo "  MAC_ARM64_DMG: $MAC_ARM64_DMG"
          echo "  MAC_X64_DMG: $MAC_X64_DMG"
          echo "  WIN_EXE: $WIN_EXE"
          
          # Generate sha512 in base64 format (electron-updater requirement)
          get_sha512_base64() {
            sha512sum "$1" | cut -d ' ' -f 1 | xxd -r -p | base64 -w 0
          }
          
          # Generate latest-mac.yml (macOS)
          MAC_ARM64_SHA512=$(get_sha512_base64 "$MAC_ARM64_DMG")
          MAC_ARM64_SIZE=$(stat -c%s "$MAC_ARM64_DMG")
          MAC_X64_SHA512=$(get_sha512_base64 "$MAC_X64_DMG")
          MAC_X64_SIZE=$(stat -c%s "$MAC_X64_DMG")
          
          cat > artifacts/latest-mac.yml << EOF
          version: ${VERSION_NUM}
          files:
            - url: muyu-${VERSION}-mac-arm64.dmg
              sha512: ${MAC_ARM64_SHA512}
              size: ${MAC_ARM64_SIZE}
            - url: muyu-${VERSION}-mac-x64.dmg
              sha512: ${MAC_X64_SHA512}
              size: ${MAC_X64_SIZE}
          path: muyu-${VERSION}-mac-arm64.dmg
          sha512: ${MAC_ARM64_SHA512}
          releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          EOF
          
          # Generate latest.yml (Windows)
          WIN_SHA512=$(get_sha512_base64 "$WIN_EXE")
          WIN_SIZE=$(stat -c%s "$WIN_EXE")
          
          cat > artifacts/latest.yml << EOF
          version: ${VERSION_NUM}
          files:
            - url: muyu-${VERSION}-win-x64.exe
              sha512: ${WIN_SHA512}
              size: ${WIN_SIZE}
          path: muyu-${VERSION}-win-x64.exe
          sha512: ${WIN_SHA512}
          releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          EOF
          
          # Remove leading spaces from heredoc
          sed -i 's/^          //' artifacts/latest-mac.yml
          sed -i 's/^          //' artifacts/latest.yml
          
          echo "\nðŸ“„ Generated latest-mac.yml:"
          cat artifacts/latest-mac.yml
          echo "\nðŸ“„ Generated latest.yml:"
          cat artifacts/latest.yml

      - name: â˜ï¸ Upload to Volcengine TOS
        env:
          TOS_ACCESS_KEY: ${{ secrets.VOLCENGINE_ACCESS_KEY_ID }}
          TOS_SECRET_KEY: ${{ secrets.VOLCENGINE_SECRET_ACCESS_KEY }}
        run: |
          # Install tosutil (Volcengine TOS CLI)
          wget -q https://tos-tools.tos-cn-beijing.volces.com/tosutil/0.1.30/tosutil-linux-amd64.tar.gz
          tar -xzf tosutil-linux-amd64.tar.gz
          chmod +x tosutil
          
          # Configure credentials
          ./tosutil config -i "$TOS_ACCESS_KEY" -k "$TOS_SECRET_KEY" -e "tos-cn-beijing.volces.com"
          
          # Flatten artifacts directory structure for upload
          mkdir -p upload
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.yml" \) -exec cp {} upload/ \;
          
          echo "ðŸ“¦ Files to upload:"
          ls -lah upload/
          
          # Upload all files to releases/ directory
          ./tosutil cp upload/ tos://desktop-release/ -r -f
          
          echo "âœ… Uploaded to Volcengine TOS successfully"
          echo "ðŸ“ URL: https://desktop-release.tos-cn-beijing.volces.com/"

      - name: ï¿½ðŸ“¤ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: å¹•è¯­ ${{ github.ref_name }}
          body: |
            ðŸš€ å¹•è¯­æ¡Œé¢ç‰ˆè‡ªåŠ¨æž„å»ºå‘å¸ƒ
            
            **æž„å»ºä¿¡æ¯:**
            - ç‰ˆæœ¬: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Build: #${{ github.run_number }}
            
            **ä¸‹è½½è¯´æ˜Ž:**
            - **macOS Intel**: `muyu-*-mac-x64.dmg`
            - **macOS Apple Silicon (M1/M2/M3)**: `muyu-*-mac-arm64.dmg`
            - **Windows**: `muyu-*-win-x64.exe`
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
