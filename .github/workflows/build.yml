name: Build & Release

on:
  push:
    tags:
      - 'v*'  # ä»»ä½• v å¼€å¤´çš„ tag éƒ½ä¼šè§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            buildArgs: "--mac dmg --x64"
            artifactName: mac-intel-dmg
            artifactPath: "dist/*.dmg"
          - os: macos-latest
            buildArgs: "--mac dmg --arm64"
            artifactName: mac-apple-silicon-dmg
            artifactPath: "dist/*.dmg"
          - os: windows-latest
            buildArgs: "--win nsis"
            artifactName: windows-exe
            artifactPath: "dist/*.exe"
    runs-on: ${{ matrix.os }}

    steps:
      - name: ğŸšš Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install --prefer-offline --no-audit
        continue-on-error: false

      - name: ğŸ” Import Apple signing certificate
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Allow codesign to access the certificate
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "âœ… Certificate imported successfully"

      - name: ğŸ§± Build Electron target
        env:
          MUYU_API_DOMAIN: https://muyu-api.mengdaai.com
          MUYU_WEB_URL: https://muyu-web.mengdaai.com
          STT_BACKEND_ENDPOINT: wss://muyu-api.mengdaai.com/api/v1/stt/stream
          # macOS signing and notarization
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          npm run build:renderer
          npx electron-builder ${{ matrix.buildArgs }} --publish never

      - name: ğŸ“‹ List dist directory
        shell: bash
        run: ls -lah dist/ || dir dist\

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifactName }}
          path: ${{ matrix.artifactPath }}
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ List artifacts
        run: |
          ls -lah artifacts/
          find artifacts -type f

      - name: ğŸ“¤ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: å¹•è¯­ ${{ github.ref_name }}
          body: |
            ğŸš€ å¹•è¯­æ¡Œé¢ç‰ˆè‡ªåŠ¨æ„å»ºå‘å¸ƒ
            
            **æ„å»ºä¿¡æ¯:**
            - ç‰ˆæœ¬: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Build: #${{ github.run_number }}
            
            **ä¸‹è½½è¯´æ˜:**
            - **macOS Intel**: `muyu-*-mac-x64.dmg`
            - **macOS Apple Silicon (M1/M2/M3)**: `muyu-*-mac-arm64.dmg`
            - **Windows**: `muyu-*-win-x64.exe`
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
