name: Cleanup Old Artifacts
on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // è·å–æ‰€æœ‰ artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            console.log(`æ‰¾åˆ° ${artifacts.data.artifacts.length} ä¸ª artifacts`);
            
            // åˆ é™¤è¶…è¿‡ 2 å¤©çš„ artifacts
            // (build.yml ä¸­è®¾ç½®äº† retention-days: 1,è¿™é‡Œä½œä¸ºé¢å¤–ä¿é™©)
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < twoDaysAgo) {
                console.log(`åˆ é™¤æ—§ artifact: ${artifact.name} (ID: ${artifact.id}, åˆ›å»ºäº: ${artifact.created_at})`);
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                } catch (error) {
                  console.log(`æ— æ³•åˆ é™¤ artifact ${artifact.id}: ${error.message}`);
                }
              }
            }
            
            console.log(`âœ… æ¸…ç†å®Œæˆ! åˆ é™¤äº† ${deletedCount} ä¸ªæ—§ artifacts`);

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Workflow Runs (å¯é€‰)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ä¿ç•™æœ€è¿‘ 30 å¤©çš„ workflow runs
            const daysToKeep = 30;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
            
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });
            
            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100
              });
              
              for (const run of runs.data.workflow_runs) {
                const runDate = new Date(run.created_at);
                if (runDate < cutoffDate && run.status === 'completed') {
                  console.log(`åˆ é™¤æ—§çš„ workflow run: ${run.name} (${run.id}) - ${run.created_at}`);
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner,
                      repo,
                      run_id: run.id
                    });
                  } catch (error) {
                    console.log(`æ— æ³•åˆ é™¤ run ${run.id}: ${error.message}`);
                  }
                }
              }
            }
            
            console.log('âœ… Workflow runs æ¸…ç†å®Œæˆ!');
